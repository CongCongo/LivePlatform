<!DOCTYPE html>
<html>
    <head>
        <title>教育直播</title>
        <link rel="stylesheet" href="vendor/bootstrap.min.css">
        <script src="AgoraRTCSDK-1.12.0.js"></script>
        <script src="vendor/jquery.js"></script>
    </head>
    <body>
        <div id="div_device" class="panel panel-default" style="display:none">
            <div class="select">
                <label for="audioSource">Audio source: </label><select id="audioSource"></select>
            </div>
            <div class="select">
                <label for="videoSource">Video source: </label><select id="videoSource"></select>
            </div>
        </div>

        <div id="div_join" class="panel panel-default">
            <div class="panel-body">
                房间号: <input id="channel" type="text" value="1000" size="4"></input>
                <button id="join" class="btn btn-primary" onclick="join()">开始你的表演</button>
                <button id="leave" class="btn btn-primary" onclick="leave()">溜了</button>
                <button id="publish" class="btn btn-primary" onclick="publish()">重启直播</button>
                <button id="unpublish" class="btn btn-primary" onclick="unpublish()">暂停直播</button>
            </div>
        </div>

    <!--style>
    .video__box{width:910px; margin:0 auto; overflow:hidden;}
    .video__main{ width:810px; height:607px;float:left }
    .video__list{ width:200px; height:607px; float:left;}
    .video__item{ width:200px; height:174px; hei background:url(/img/icon_live.png) center center no-repeat; }
    </style>
    <div class="video__main">
    </div>
    <div class="video__list">
        <div class="video__item"></div>
        <div id="video" class="video__item">
            <div id="agora_local"></div>
        </div>
    </div-->

<div id="video" style="margin:0 auto;">
    <div id="agora_local" style="float:right;width:500px;height:347px;display:inline-block;"></div>
</div>

<script language="javascript">
var client, localStream, camera, microphone;

var audioSelect = document.querySelector('select#audioSource');
var videoSelect = document.querySelector('select#videoSource');

function join() {
  document.getElementById("join").disabled = true;
  var dynamic_key = null;
  var app_key = "0c6a0a8f844c49d78a9aac0907dfc1d8";
  // for dynamic key
  /*console.log("Try to get dynamic key");
  var use_https = ('https:' == document.location.protocol ? true : false);
  if (use_https) {
    var url_str = "https://ip:port/dynamic_key?channelName=" + channel.value;
  } else {
    var url_str = "http://ip:port/dynamic_key?channelName=" + channel.value;
  }
  $.ajax({
    url: url_str,
    error: function() {
      console.log("Failed to get dynamic key");
    },
    success: function(response) {
      console.log(response.key);
      dynamic_key = response.key;*/

  console.log("Init AgoraRTC client with vendor key: " + app_key);
  //创建客户端
  client = AgoraRTC.createClient({mode: 'interop'});
  //初始化客户端
  client.init(app_key, function () {
    console.log("AgoraRTC client initialized");
    //加入频道，uid由系统返还
    client.join(dynamic_key, channel.value, null, function(uid) {
      console.log("User " + uid + " join channel successfully");
      //他是主播
        camera = videoSource.value;
        microphone = audioSource.value;
        //创建本地音视频流
        localStream = AgoraRTC.createStream({streamID: uid, audio: true, cameraId: camera, microphoneId: microphone, video:true, screen: false});
          localStream.setVideoProfile('720p_3');
        localStream.init(function() {
          console.log("getUserMedia successfully");
          //播放本地音视频流
          localStream.play('agora_local');

          //将本地音视频流发布到agora服务器
          client.publish(localStream, function (err) {
            console.log("Publish local stream error: " + err);
          });
          //本地音视频已上传回调事件
          client.on('stream-published', function (evt) {
            console.log("Publish local stream successfully");
          });
        }, function (err) {
          console.log("getUserMedia failed", err);
        });
    }, function(err) {
      console.log("Join channel failed", err);
    });
  }, function (err) {
    console.log("AgoraRTC client init failed", err);
  });

  var channelKey = "";
  client.on('error', function(err) {
    console.log("Got error msg:", err.reason);
    if (err.reason === 'DYNAMIC_KEY_TIMEOUT') {
      client.renewChannelKey(channelKey, function(){
        console.log("Renew channel key successfully");
      }, function(err){
        console.log("Renew channel key failed: ", err);
      });
    }
  });

  client.on('peer-leave', function (evt) {
    var stream = evt.stream;
    if (stream) {
      stream.stop();
      $('#agora_remote' + stream.getId()).remove();
      console.log(evt.uid + " leaved from this channel");
    }
  });
  // for dynamic key
  /*}
  });*/
}

function leave() {
  document.getElementById("leave").disabled = true;
  client.leave(function () {
    console.log("Leavel channel successfully");
  }, function (err) {
    console.log("Leave channel failed");
  });
}

function publish() {
  document.getElementById("publish").disabled = true;
  document.getElementById("unpublish").disabled = false;
  client.publish(localStream, function (err) {
    console.log("Publish local stream error: " + err);
  });
}

function unpublish() {
  document.getElementById("publish").disabled = false;
  document.getElementById("unpublish").disabled = true;
  client.unpublish(localStream, function (err) {
    console.log("Unpublish local stream failed" + err);
  });
}

</script>
</body>
</html>
